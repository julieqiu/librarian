# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
name: Sidekick
on: [push, pull_request, merge_group]
permissions:
  contents: read
jobs:
  test:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
      - name: Display Go version
        run: go version
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Display Cargo version
        run: cargo version
      - name: Display rustc version
        run: rustup show active-toolchain -v
      - name: Install taplo
        run: |
          set -e
          curl -fsSL https://github.com/tamasfe/taplo/releases/latest/download/taplo-linux-x86_64.gz | gunzip -c - | sudo tee /usr/local/bin/taplo > /dev/null
          sudo chmod +x /usr/local/bin/taplo
          taplo --version
      - name: Install protoc
        run: |
          set -e
          curl -fsSL --retry 5 --retry-delay 15 -o /tmp/protoc.zip https://github.com/protocolbuffers/protobuf/releases/download/v29.3/protoc-29.3-linux-x86_64.zip
          cd /usr/local
          sudo unzip -o /tmp/protoc.zip
          protoc --version
      - name: Verify git and tar are available
        run: |
          git --version
          tar --version
      - name: Run sidekick tests
        run: go test -race ./internal/sidekick/...
      - name: Run internal/language/internal/rust tests
        run: go test -race ./internal/language/internal/rust
