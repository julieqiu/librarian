# Librarian Configuration Design

## Objective

Defines the configurations used by the Librarian CLI.

## Background

Configuring a Google Cloud client library has historically required stitching
together state from multiple, disparate files, coupling language-neutral
concerns with language-specific decisions. This created friction and manual
work.

Librarian introduces a unified configuration architecture that decouples these
concerns and establishes a clear, predictable flow of information from upstream
API definitions to downstream client libraries.

## Configuration by Repository

Our design structures configuration into distinct domains of ownership, grouped
by the repository where the configuration files live. Librarian acts as the
integration engine, reconciling these inputs to produce consistent,
high-quality client libraries.

### `googleapis/googleapis` Repository (Upstream API Definitions)

The `googleapis/googleapis` repository serves as the **upstream source of
truth** for all Google Cloud API definitions. `librarian` pulls specific
commits of this repository to ensure deterministic and reproducible builds.

#### 1. API Definitions (`.proto` files)
-   **Content:** These files are the primary contract, defining the RPC
    interfaces, messages, and enums for each API.
-   **Organization:** APIs are typically organized by
    `google/<cloud_product>/<version>/`.

#### 2. The API Service Definition (`serviceconfig.yaml`)

This file defines the surface and behavior of a Google API. This is
service-neutral information owned and maintained by the service teams.

-   **Content:** It defines the API's `release_level`, supported `transports`
    (gRPC, REST), request deadlines, retry policies, and authentication scopes.
-   **Librarian's Role:** Librarian reads this file but does not modify it. The
    `publishing:` section within this file is **deprecated** in favor of
    `sdk.yaml` and `librarian.yaml`.

#### 3. The SDK Manifest (`sdk.yaml`)

The `sdk.yaml` file (the Central Catalog) acts as the **central manifest of all
APIs available for client library generation**. It is maintained by the
Librarian team.

-   **Purpose:** It provides a discoverable list of "onboarded" APIs, defines
    their canonical source paths within `googleapis/googleapis`, and
    categorizes them as `standard` or `legacy`.
-   **Structure:** It does **not** define library names, as these vary by language. It only lists the raw API definitions.
    -   `standard`: APIs supported by default across languages.
    -   `legacy`: APIs maintained for backward compatibility, often restricted to a subset of languages.

---

### `googleapis/librarian` Repository (Tooling Definitions)

This repository contains the configuration for the `librarian` tool itself.

#### 4. CLI Dependencies (`tool.yaml`)

The `tool.yaml` file defines the specifications for the dependencies required by the Librarian CLI.

-   **Purpose:** It declares required runtimes (e.g., Python, Rust) and
    external tools, ensuring a reproducible environment for developers and CI.
-   **Structure:** Defines tool versions categorized by their installer (e.g.,
    `pip`, `cargo`).

---

### Language Repositories (`googleapis/google-cloud-<lang>`)

Each language repository contains its own manifest that defines how it
participates in the ecosystem.

#### 5. The Repository Manifest (`librarian.yaml`)

This manifest, located in the root of each language repository (e.g.,
`googleapis/google-cloud-rust/librarian.yaml`), contains information specific
to that language and workspace.

-   **Purpose:** It is the authoritative source for the list of libraries
    managed in the repository, their versions, output locations, and any
    language-specific generator configurations or overrides.
-   **Structure:**
    -   **Top-Level:** `language`, `repo`, `default` settings, and `sources` dependencies.
    -   **`libraries`:** A list of managed libraries, each with its `name`,
        `version`, `channels` (API versions), and language-specific blocks
        (`rust:`, `python:`, `go:`).

---

## Key Concepts

### Library Types

Librarian must know what kind of library it is working with to make the right
decisions about what to generate and what to preserve. The type is inferred
from the presence or absence of specific configuration fields.

The classification logic proceeds in order:

1.	If `veneer` is true and the library has language-specific modules, it is a **veneer with generated layers**.
2.	If `veneer` is true but the library has no modules, it is a **purely handwritten veneer**.
3.	If the library has a `keep` field, it is **hybrid**.
4.	If a service configuration exists for the API path, it is **autogenerated with service config**.
5.	Otherwise, it is **autogenerated from proto only**.

---

### Alternatives Considered

We considered merging `tool.yaml` with `librarian.yaml`, using
`serviceconfig.yaml` for onboarding, maintaining the status quo of distributed
config, and creating a single monolithic config file. These were rejected to
maintain clear ownership boundaries, ensure a deliberate API onboarding
process, and avoid creating maintenance bottlenecks.

### Migration Plan

Librarian will use an enhanced `sdk.yaml` as the central, declarative
configuration hub during the transition period. Librarian will be the sole
orchestrator, reading `sdk.yaml`, `librarian.yaml`, and `serviceconfig.yaml` to
synthesize the final configuration artifacts (like legacy `GAPIC YAML` files)
required by language-specific generators, which will be decoupled from legacy
upstream configurations.

### Consolidation Mapping

The following table outlines the planned consolidation of legacy configuration files into the unified manifests:

| Legacy File                       | Primary Fields                                     | New Location                 |
|:----------------------------------|:---------------------------------------------------|:-----------------------------|
| **`*_gapic.yaml`**                | Package names, class overrides, generation options | `librarian.yaml`             |
| **`BUILD.bazel`**                 | Transport settings, numeric enum behavior          | `serviceconfig`              |
| **`*_grpc_service_config.json`**  | Retry policies, request deadlines                  | `serviceconfig`              |
| **`.sidekick.toml`**              | Library inventory, state, Rust-specific settings   | `librarian.yaml`             |
| **`.librarian/state.yaml`**       | Library versions, generated commits, metadata      | `librarian.yaml`             |
| **`synthtool` (post-processing)** | Custom file movement, templating logic             | `librarian.yaml` (minimized) |

### Deprecation

Once all of the GAPIC generators have migrated, we will delete the legacy
configuration files.
